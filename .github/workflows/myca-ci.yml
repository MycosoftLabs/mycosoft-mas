# MYCA Self-Improvement System CI Pipeline
# Validates MYCA constitution compliance, permissions, and safety
# Date: February 17, 2026

name: MYCA CI

on:
  push:
    branches: [main, develop, 'feature/**']
    paths:
      - 'mycosoft_mas/myca/**'
      - 'mycosoft_mas/security/**'
      - 'scripts/myca_skill_lint.py'
      - '.github/workflows/myca-*.yml'
  pull_request:
    branches: [main]
    paths:
      - 'mycosoft_mas/myca/**'
      - 'mycosoft_mas/security/**'
      - 'scripts/myca_skill_lint.py'
      - '.github/workflows/myca-*.yml'

jobs:
  lint-permissions:
    name: Lint Skill Permissions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema pyyaml

      - name: Lint skill permissions
        run: |
          python scripts/myca_skill_lint.py --strict
        continue-on-error: false

  validate-schema:
    name: Validate Permission Schema
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install jsonschema

      - name: Validate all PERMISSIONS.json files
        run: |
          python -c "
          import json
          import sys
          from pathlib import Path
          from jsonschema import validate, ValidationError
          
          schema_path = Path('mycosoft_mas/myca/skill_permissions/_schema/PERMISSIONS.schema.json')
          schema = json.loads(schema_path.read_text())
          
          permissions_dir = Path('mycosoft_mas/myca/skill_permissions')
          errors = []
          
          for perm_file in permissions_dir.glob('*/PERMISSIONS.json'):
              try:
                  data = json.loads(perm_file.read_text())
                  validate(instance=data, schema=schema)
                  print(f'✓ {perm_file.parent.name}')
              except ValidationError as e:
                  errors.append(f'{perm_file}: {e.message}')
                  print(f'✗ {perm_file.parent.name}: {e.message}')
          
          if errors:
              print(f'\\n{len(errors)} validation errors found')
              sys.exit(1)
          print('\\nAll permission files valid')
          "

  run-evals:
    name: Run Safety Evaluations
    runs-on: ubuntu-latest
    needs: [lint-permissions, validate-schema]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pyyaml jsonschema pydantic

      - name: Run MYCA evaluations
        run: |
          python -m mycosoft_mas.myca.evals.run_evals --verbose --report eval-report.json
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Upload eval report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: myca-eval-report
          path: eval-report.json
          retention-days: 30

  check-constitution:
    name: Check Constitution Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify constitution files exist
        run: |
          required_files=(
            "mycosoft_mas/myca/constitution/SYSTEM_CONSTITUTION.md"
            "mycosoft_mas/myca/constitution/TOOL_USE_RULES.md"
            "mycosoft_mas/myca/constitution/PROMPT_INJECTION_DEFENSE.md"
            "mycosoft_mas/myca/constitution/OUTPUT_STANDARDS.md"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Missing required constitution file: $file"
              exit 1
            fi
            echo "✓ $file"
          done
          echo "All constitution files present"

      - name: Check for forbidden patterns in constitution
        run: |
          # Constitution files should not contain executable code or secrets
          grep -rn "exec(" mycosoft_mas/myca/constitution/ && exit 1 || true
          grep -rn "eval(" mycosoft_mas/myca/constitution/ && exit 1 || true
          grep -rn "sk-[a-zA-Z0-9]" mycosoft_mas/myca/constitution/ && exit 1 || true
          echo "No forbidden patterns in constitution"

  check-event-ledger:
    name: Validate Event Ledger
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Test event ledger module
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          
          from mycosoft_mas.myca.event_ledger import EventLedger, hash_args
          
          # Test hash_args
          result = hash_args({'key': 'value'})
          assert result.startswith('sha256:'), 'hash_args should return sha256 prefix'
          print('✓ hash_args works')
          
          # Test empty hash
          empty_hash = hash_args({})
          assert empty_hash.startswith('sha256:'), 'empty hash should work'
          print('✓ empty hash works')
          
          print('Event ledger module validated')
          "

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint-permissions, validate-schema, run-evals, check-constitution, check-event-ledger]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.lint-permissions.result }}" != "success" ] || \
             [ "${{ needs.validate-schema.result }}" != "success" ] || \
             [ "${{ needs.run-evals.result }}" != "success" ] || \
             [ "${{ needs.check-constitution.result }}" != "success" ] || \
             [ "${{ needs.check-event-ledger.result }}" != "success" ]; then
            echo "One or more MYCA CI jobs failed"
            exit 1
          fi
          echo "All MYCA CI jobs passed!"
