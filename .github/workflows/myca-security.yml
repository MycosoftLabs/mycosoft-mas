# MYCA Security Audit Workflow
# Runs security-focused checks on MYCA-related code changes
# Date: February 17, 2026

name: MYCA Security

on:
  push:
    branches: [main]
    paths:
      - 'mycosoft_mas/myca/**'
      - 'mycosoft_mas/security/**'
      - 'mycosoft_mas/safety/**'
  pull_request:
    branches: [main]
    paths:
      - 'mycosoft_mas/myca/**'
      - 'mycosoft_mas/security/**'
      - 'mycosoft_mas/safety/**'
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'

jobs:
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for secrets
        run: |
          # Define secret patterns
          patterns=(
            'sk-[a-zA-Z0-9]{48}'
            'sk-ant-[a-zA-Z0-9-]{93}'
            'AIza[0-9A-Za-z-_]{35}'
            'ghp_[a-zA-Z0-9]{36}'
            'gho_[a-zA-Z0-9]{36}'
            'AKIA[0-9A-Z]{16}'
            '-----BEGIN.*PRIVATE KEY-----'
          )
          
          found=0
          for pattern in "${patterns[@]}"; do
            if grep -rEn "$pattern" mycosoft_mas/ --include="*.py" --include="*.json" --include="*.md" 2>/dev/null; then
              echo "Found potential secret matching: $pattern"
              found=1
            fi
          done
          
          if [ $found -eq 1 ]; then
            echo "Secret scan failed - potential secrets found"
            exit 1
          fi
          echo "✓ No secrets found"

  permission-escalation-check:
    name: Check for Permission Escalation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for permission escalation patterns
        run: |
          python -c "
          import json
          import sys
          from pathlib import Path
          
          permissions_dir = Path('mycosoft_mas/myca/skill_permissions')
          issues = []
          
          for perm_file in permissions_dir.glob('*/PERMISSIONS.json'):
              data = json.loads(perm_file.read_text())
              skill_name = perm_file.parent.name
              
              # Check: high risk skills must require sandbox
              if data.get('risk_tier') == 'high':
                  limits = data.get('limits', {})
                  if not limits.get('sandbox_required', False):
                      issues.append(f'{skill_name}: high risk tier but sandbox not required')
              
              # Check: no secrets access for low risk
              if data.get('risk_tier') == 'low':
                  secrets = data.get('secrets', {})
                  if secrets.get('allowed_scopes'):
                      issues.append(f'{skill_name}: low risk tier but has secret access')
              
              # Check: dangerous tools should be in deny list
              dangerous_tools = ['merge_pr', 'force_push', 'delete_branch', 'delete_file_permanent']
              tools = data.get('tools', {})
              allow_list = tools.get('allow', [])
              deny_list = tools.get('deny', [])
              
              for tool in dangerous_tools:
                  if tool in allow_list and tool not in deny_list:
                      if data.get('risk_tier') != 'high':
                          issues.append(f'{skill_name}: dangerous tool {tool} allowed without high risk tier')
          
          if issues:
              print('Permission escalation issues found:')
              for issue in issues:
                  print(f'  - {issue}')
              sys.exit(1)
          
          print('✓ No permission escalation issues')
          "

  dangerous-pattern-scan:
    name: Scan for Dangerous Patterns
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for dangerous patterns
        run: |
          echo "Checking for dangerous patterns in MYCA code..."
          
          # Patterns that should not appear in MYCA code
          dangerous=(
            "eval(.*input"
            "exec(.*input"
            "os.system"
            "__import__.*user"
            "subprocess.call.*shell=True"
            "pickle.loads"
            "yaml.load.*Loader=None"
            "yaml.unsafe_load"
          )
          
          found=0
          for pattern in "${dangerous[@]}"; do
            if grep -rEn "$pattern" mycosoft_mas/myca/ 2>/dev/null; then
              echo "Found dangerous pattern: $pattern"
              found=1
            fi
          done
          
          if [ $found -eq 1 ]; then
            echo "Dangerous pattern scan failed"
            exit 1
          fi
          echo "✓ No dangerous patterns found"

  adversarial-evals:
    name: Run Adversarial Evaluations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install pyyaml jsonschema pydantic

      - name: Run adversarial tests
        run: |
          python -m mycosoft_mas.myca.evals.run_evals \
            --category jailbreak \
            --verbose \
            --report adversarial-report.json
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Upload adversarial report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: adversarial-eval-report
          path: adversarial-report.json
          retention-days: 30

  audit-log-integrity:
    name: Check Audit Log Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify audit logging is configured
        run: |
          # Check that audit.py has EventLedger integration
          if ! grep -q "EventLedger" mycosoft_mas/security/audit.py; then
            echo "ERROR: EventLedger not integrated in audit.py"
            exit 1
          fi
          echo "✓ EventLedger integration present"
          
          # Check that tool_pipeline.py has permission enforcement
          if ! grep -q "permission" mycosoft_mas/llm/tool_pipeline.py; then
            echo "WARNING: Permission enforcement may be missing in tool_pipeline.py"
          fi
          echo "✓ Audit configuration verified"

  deny-list-coverage:
    name: Verify Deny List Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check deny list coverage
        run: |
          python -c "
          import json
          import sys
          from pathlib import Path
          
          # Sensitive paths that should be denied
          required_deny_paths = [
              '**/.env*',
              '**/*secret*',
              '**/*credential*',
              '**/.*_history',
          ]
          
          permissions_dir = Path('mycosoft_mas/myca/skill_permissions')
          issues = []
          
          for perm_file in permissions_dir.glob('*/PERMISSIONS.json'):
              data = json.loads(perm_file.read_text())
              skill_name = perm_file.parent.name
              
              filesystem = data.get('filesystem', {})
              deny_paths = filesystem.get('deny', [])
              
              # Check that sensitive paths are denied
              missing = []
              for required in required_deny_paths:
                  found = False
                  for deny in deny_paths:
                      if required in deny or deny in required:
                          found = True
                          break
                  if not found:
                      missing.append(required)
              
              if missing and data.get('risk_tier') != 'low':
                  issues.append(f'{skill_name}: missing deny paths: {missing}')
          
          if issues:
              print('Deny list coverage issues:')
              for issue in issues:
                  print(f'  - {issue}')
              # Warning only, not blocking
              print('\\nWARNING: Some skills may need additional deny paths')
          else:
              print('✓ Deny list coverage looks good')
          "

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, permission-escalation-check, dangerous-pattern-scan, adversarial-evals, audit-log-integrity, deny-list-coverage]
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "## MYCA Security Check Results"
          echo ""
          echo "| Check | Status |"
          echo "|-------|--------|"
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |"
          echo "| Permission Escalation | ${{ needs.permission-escalation-check.result }} |"
          echo "| Dangerous Patterns | ${{ needs.dangerous-pattern-scan.result }} |"
          echo "| Adversarial Evals | ${{ needs.adversarial-evals.result }} |"
          echo "| Audit Log Integrity | ${{ needs.audit-log-integrity.result }} |"
          echo "| Deny List Coverage | ${{ needs.deny-list-coverage.result }} |"
          
          # Check for failures
          if [ "${{ needs.secret-scan.result }}" != "success" ] || \
             [ "${{ needs.permission-escalation-check.result }}" != "success" ] || \
             [ "${{ needs.dangerous-pattern-scan.result }}" != "success" ]; then
            echo ""
            echo "⚠️ Critical security checks failed!"
            exit 1
          fi
          echo ""
          echo "✓ All critical security checks passed"
