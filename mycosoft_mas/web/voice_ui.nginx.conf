server {
  listen 80;
  server_name _;

  # Docker DNS (prevents hard-fail on optional upstreams)
  resolver 127.0.0.11 ipv6=off valid=10s;

  # Serve the UI
  location / {
    root /usr/share/nginx/html;
    index index.html;
    try_files $uri $uri/ =404;
  }

  # Same-origin proxies to avoid browser CORS issues
  location /api/whisper/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://whisper:8000/;
  }

  # TTS: Use openedai-speech as primary (always available)
  # ElevenLabs proxy only available with voice-premium profile
  location /api/tts/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # Use openedai-speech as default TTS (always running)
    proxy_pass http://openedai-speech:8000/;
  }

  # Optional ElevenLabs TTS endpoint (only when voice-premium profile is active)
  location /api/tts/premium/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    set $elevenlabs_upstream "http://elevenlabs-proxy:8000";
    proxy_pass $elevenlabs_upstream/;
  }


  location /api/ollama/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    # Optional dependency; use variable to avoid startup DNS hard-fail.
    set $ollama_upstream "http://ollama:11434";
    proxy_pass $ollama_upstream;
  }

  # MAS Orchestrator API (inside docker network)
  location /api/mas/ {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://mas-orchestrator:8000/;
  }
}
